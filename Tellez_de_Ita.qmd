---
title: "Tellez de Ita"
author: "Rodrigo Tellez de Ita"
format: html
---

```{r}
#| warning: false
here::i_am("grades.Rproj")
library(here)
library(dplyr)
library(readr)
library(vroom)
library(tidyr)
library(ggplot2)
library(stringr)

```

# 1. Introduction

Link: https://github.com/Rodrigotdi/grades.git


## 1.1 Study organisation

### Question 1: Loading of course

```{r}
#| message: false
course <- vroom(here("courses.csv"))
```

### Question 2


```{r}
#| message: false
course_table <- course|> rename ("course name"=course)|>rename(identifier=course_id)|> rename("number of exams"=nb_grades) |> knitr::kable()
course_table
```

## 1.2 Students

### Question 3

```{r}
#| message: false
students <- vroom(here("students.csv"),
                  col_types = cols(
  id = col_integer(),
  group = col_factor(),
  birth_date = col_date(format = ""),
  sex = col_factor()
))

paste(
  "The birth_date column of the students data frame is of class",
  class(students$birth_date)
)

```

## 1.3 Grades

### Question 4


```{r}
#| message: false
grades <- read_delim(here("grades.csv"),delim=";",na="_")
```

# 2. Student population analysis

### Question 5

```{r}

ggplot(students,aes(x=group))+
  geom_bar()+
  theme_minimal()
```

### Question 6

```{r}
students |>
  ggplot(aes(x = group, fill = sex)) +
  geom_bar(position = "dodge")+
  theme_minimal()
```

### Question 7


```{r}
#| message: false
library(lubridate)

students_age <- students |>
  mutate(age = time_length(today() - birth_date, unit = "year"))
ggplot(students_age, aes(x = age)) +
  geom_histogram() +
  theme_minimal()
```



### Question 8


```{r}
students_age |>
  summarise(
    median_age = round(median(age)),
    .by = group
  ) |>
  arrange(group) |> knitr::kable()

```

### Question 9

```{r}
oldest_per_group <- students_age |>
  slice_max(age, n = 1,by = group) |>
  mutate(age = round(age)) |>
  select(group,id, sex, age) |> 
  arrange(desc(age))|>
  rename("oldest age"=age)|>
  knitr::kable()

oldest_per_group
```

# 3. Simple Grade analysis

### Question 10 


```{r}
num_grades <- grades |>
  filter(!is.na(grade)) |>
  nrow()
paste("The data set contains", num_grades, "grades.")
```


### Question 11

```{r}
grades |>
  filter(!is.na(grade)) |>
  left_join(course |> select(course_id, course), by=join_by(course_id)) |>
  filter(course == "History of the Arcane") |>
  left_join(students |> select(id, group), by=join_by(id)) |>
  summarise(avg_group = mean(grade), .by = group) |>
  ggplot(aes(x = group, y = avg_group)) +
  geom_col()+
  theme_minimal()
```


### Question 12


```{r}
grades |>
  filter(!is.na(grade)) |>
  left_join(
    course |> select(course_id, trimester), join_by(course_id)) |>
  ggplot(aes(x = factor(trimester), y = grade)) +
  geom_boxplot() +
  theme_minimal()
```


# 4. Attendance analysis

### Question 13

```{r}
grades_per_student <- grades |>
  filter(!is.na(grade)) |>
  summarise(num_grades = n(), .by = id) |>
  left_join(students |> select(id, group, sex), join_by(id)) |> 
  slice_head(n = 5) 

grades_per_student

```

```{r}
grades_per_student |>
  summarise(
    min_grades = min(num_grades),
    max_grades = max(num_grades),
    avg_grades = mean(num_grades),
    median_grades = median(num_grades)
  ) |> knitr::kable()

```

### Question 14


```{r}
grades |>
  filter(!is.na(grade)) |>
  summarise(num_grades = n(), .by = id) |> 
  left_join(students |> select(id, sex), join_by(id)) |>
  ggplot(aes(x = num_grades, fill = sex)) +
  geom_histogram(position = "dodge",bins=22) + theme_minimal()
```


### Question 15


```{r}
CNA <- grades |>
  filter(!is.na(grade)) |>
  left_join(course |> select(course_id, course),join_by(course_id)) |>
  filter(course == "Celestial Navigation and Astronomy") |>
  summarise(
    nb_grades_cna = n(),
    .by = id
  ) |>
  left_join(
    students |> select(id, group),
    join_by(id)
  ) |>
  select(id, group, nb_grades_cna)

CNA |>slice_head(n=5)
```


### Question 16

```{r}
CNA|>summarise(n_students=n(), .by=nb_grades_cna) |> ggplot(aes(x=nb_grades_cna,y=n_students))+
  geom_col()
```

### Question 17

```{r}
grades |>
  filter(!is.na(grade)) |>
  left_join(
    course |> select(course_id, course),
    join_by(course_id)
  ) |>
  filter(course == "Celestial Navigation and Astronomy") |>
  summarise(
    nb_grades_cna = n(),
    .by = id
  ) |>
  left_join(
    students |> select(id, group),
    join_by(id)
  ) |>
  ggplot(aes(x = group, y = nb_grades_cna)) +
  geom_boxplot() + theme_minimal()
```

### Question 18

```{r}
grades |>
  filter(!is.na(grade)) |>
  left_join(
    course|> select(course_id, course),
    join_by(course_id)
  ) |>
  filter(course == "Celestial Navigation and Astronomy") |>
  summarise(
    nb_grades_cna = n(),
    .by = id
  ) |>
  left_join(
    students |> select(id, group, sex),
    join_by(id)
  ) |>
  ggplot(aes(x = group, y = nb_grades_cna, fill = sex)) +
  geom_boxplot() + theme_minimal()
```

# 5. Grade analysis

### Question 19

```{r}
avg_per_course <- grades |>
  filter(!is.na(grade)) |>
  left_join(
    course |> select(course_id, course),
    join_by(course_id)
  ) |>
  summarise(
    avg_grade = mean(grade),
    .by = c(id, course)
  ) |>
  left_join(
    students |> select(id, group),
    join_by(id)
  )


avg_wider <- avg_per_course |>
  select(id, group, course, avg_grade) |>
  pivot_wider(
    names_from = course,
    values_from = avg_grade
  )

avg_wider|>select(id,group,`Ancient Magic and Mysticism`,`Celestial Navigation and Astronomy`)|>
  slice_head(n=5)|>knitr::kable()
```


### Question 20

```{r}
avg_wider|> ggplot(aes(x=`Illusion and Enchantment`,y=`Ancient Magic and Mysticism`))+
  geom_point()+theme_minimal()
```

### Question 21

```{r}
avg_wider |> summarise(cor_ill_cna=cor(`Illusion and Enchantment`,`Celestial Navigation and Astronomy`), .by = group)|> knitr::kable()
```

### Question 22

```{r}
most_corr_group <- avg_wider |> summarise(cor_ill_cna=cor(`Illusion and Enchantment`,`Celestial Navigation and Astronomy`), .by = group)|> slice_max(abs(cor_ill_cna),n=1)|>select(group)

avg_wider|>semi_join(most_corr_group,by=join_by(group))|>ggplot(aes(x=`Illusion and Enchantment`,y=`Ancient Magic and Mysticism`))+
  geom_point()+theme_minimal()
 
```

### Question 23

```{r}
final_grades <- grades |>
  filter(!is.na(grade)) |>
  summarise(
    avg_course = mean(grade),
    .by = c(id, course_id)
  ) |>
 summarise(
    final_grade = mean(avg_course),
    .by = id
  ) |> left_join(
    students |> select(id, group, sex),
    join_by(id)
  ) |>
  select(id, group, sex, final_grade) |>
  arrange(desc(final_grade))

final_grades|>slice_head(n=5)|>knitr::kable()
```

### Question 24


```{r}
final_grades |>
  ggplot(aes(x = group, y = final_grade)) +
  geom_boxplot() + theme_minimal()

```

### Question 25

```{r}
final_grades |>
  ggplot(aes(x = group, y = final_grade, fill = sex)) +
  geom_boxplot() + theme_minimal()
```

### Question 26


```{r}
per_course_avg <- grades |>
  filter(!is.na(grade)) |>
  summarise(
    avg_course = mean(grade),
    .by = c(id, course_id)
  ) |>
  left_join(
    course |> select(course_id, trimester),
    join_by(course_id)
  )


pass_cond1 <- per_course_avg |>
  summarise(
    final_grade    = mean(avg_course),
    min_course_avg = min(avg_course),
    .by = id
  )


trimester_cond <- per_course_avg |>
  summarise(
    trim_avg = mean(avg_course),
    .by = c(id, trimester)
  ) |>
  summarise(
    min_trim_avg = min(trim_avg),
    .by = id
  )

```

```{r}

pass_df <- pass_cond1|>left_join(trimester_cond,by=join_by(id))|>mutate(
  pass=(min_course_avg>=5) & (min_trim_avg>=10))|>
  left_join(students,by=join_by(id))|>select(id,group,final_grade,pass)
  
pass_df|>slice_head(n=10)|>knitr::kable()

```

### Question 27

```{r}
nb_fail <- pass_df|>filter(!pass,final_grade>=10)|>nrow()

paste(
  "There are",
  nb_fail,
  "students who do not pass but have a final grade greater or equal to 10."
)
```

